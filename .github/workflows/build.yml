name: Build Deltarune Raw Dylib

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14  # Ensures an M1/M2 runner for native arm64 support

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compile Speed Tweak
        run: |
          # We use xcrun to find the official iOS SDK path on the runner
          SDK_PATH=$(xcrun --sdk iphoneos --show-sdk-path)
          
          clang++ -dynamiclib -arch arm64 \
            -isysroot "$SDK_PATH" \
            -miphoneos-version-min=14.0 \
            -fobjc-arc \
            -framework Foundation -framework UIKit \
            -install_name @executable_path/Frameworks/DeltaruneSpeed.dylib \
            -o DeltaruneSpeed.dylib \
            main.mm

      - name: Ad-hoc Sign
        run: codesign -s - DeltaruneSpeed.dylib

      - name: Upload Dylib
        uses: actions/upload-artifact@v4
        with:
          name: DeltaruneSpeed
          path: DeltaruneSpeed.dylib
